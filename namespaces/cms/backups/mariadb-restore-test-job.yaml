apiVersion: batch/v1
kind: Job
metadata:
  name: mariadb-restore-test
  namespace: cms
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/hostname: k3s-w3
      containers:
      - name: restore-test
        image: bitnami/mariadb:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: MARIADB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb
              key: mariadb-root-password
        command:
        - /bin/bash
        - -ec
        - "latest_file=$(ls -t /backups/db/*.sql.gz | head -n 1)\nif [ -z \"$latest_file\"\
          \ ]; then\n  echo \"No backup files found in /backups/db\" >&2\n  exit 1\n\
          fi\necho \"Using backup: $latest_file\"\n\nmariadb -h mariadb.cms.svc.cluster.local\
          \ -u root -p\"$MARIADB_ROOT_PASSWORD\" -e \"DROP DATABASE IF EXISTS wordpress_restore_test;\
          \ CREATE DATABASE wordpress_restore_test;\"\ngunzip -c \"$latest_file\"\
          \ | mariadb -h mariadb.cms.svc.cluster.local -u root -p\"$MARIADB_ROOT_PASSWORD\"\
          \ wordpress_restore_test\n\nmariadb -h mariadb.cms.svc.cluster.local -u\
          \ root -p\"$MARIADB_ROOT_PASSWORD\" -e \"SELECT COUNT(*) AS tables_count\
          \ FROM information_schema.tables WHERE table_schema='wordpress_restore_test';\"\
          \nmariadb -h mariadb.cms.svc.cluster.local -u root -p\"$MARIADB_ROOT_PASSWORD\"\
          \ -e \"DROP DATABASE IF EXISTS wordpress_restore_test;\"\n"
        volumeMounts:
        - name: backups
          mountPath: /backups
      volumes:
      - name: backups
        persistentVolumeClaim:
          claimName: cms-backups-pvc
